{{ ansible_managed | comment }}

types { include "/usr/share/misc/mime.types" }

server "default" {
  listen on * port 80
}

{% for server in httpd_servers %}
server "{{ server.name }}" {
{% if server.tls_only is not defined or not server.tls_only %}
  listen on * port 80
{% endif %}
{% if server.tls_only or server.tls %}
  listen on * tls port 443

  tls {
    certificate "/etc/ssl/{{ server.name }}.crt"
    key "/etc/ssl/private/{{ server.name }}.key"
    ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH"
  }

  hsts { subdomains }
{% endif %}

{% if server.root is defined %}
  root { "{{ server.root.directory }}"{% if server.root.strip is defined %}, strip {{ server.root.strip }}{% endif %} }
{% endif %}
{% if server.directory is defined %}
  directory { {% if server.directory.index is defined %}index {{ server.directory.index }}{% endif %} }
{% endif %}

{% for location in server.locations %}
  location "{{ location.path }}" {
{% if location.block is defined and location.block %}
    block
{% else %}
{% if location.root is defined %}
    root { "{{ location.root.directory }}"{% if location.root.strip  is defined %}, strip {{ location.root.strip }}{% endif %} }
{% endif %}
{% if location.fastcgi is defined and location.fastcgi.socket is defined %}
    fastcgi socket "{{ location.fastcgi.socket }}"
{% endif %}
{% endif %}
  }
{% endfor %}
}
{% if server.tls_only is defined and server.tls_only %}
server "{{ server.name }}" {
        listen on * port 80
        block return 301 "https://$SERVER_NAME$REQUEST_URI"
}
{% endif %}
{% endfor %}
